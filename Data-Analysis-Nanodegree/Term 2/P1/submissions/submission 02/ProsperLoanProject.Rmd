<style type="text/css">
<!-- used verbatim
     from: 2 column Section in R Markdown
     at: https://goo.gl/JwRLv4 -->
  .col2 {
    columns: 2 200px;         /* number of columns and width in pixels*/
    -webkit-columns: 2 200px; /* chrome, safari */
    -moz-columns: 2 200px;    /* firefox */
  }
  .col3 {
    columns: 3 100px;
    -webkit-columns: 3 100px;
    -moz-columns: 3 100px;
  }
<!-- used original as template
     from: Rmarkdown font size and header
     at:  https://goo.gl/GRJVvJ -->
  body{ /* Normal  */
        /*font-size: 12px;*/
    }
  td {  /* Table  */
    /*font-size: 8px;*/
  }
  h1.title {
    color: DarkBlue;
  }
  h1 { /* Header 1 */
    color: DarkBlue;
  }
  h2 { /* Header 2 */
    /*font-size: 22px;*/
    color: DarkBlue;
  }
  h3 { /* Header 3 */
    /* font-size: 18px; */
    /* font-family: "Times New Roman", Times, serif; */
    color: DarkBlue;
  }
  code.r{ /* Code block */
      /* font-size: 12px; */
  }
  pre { /* Code block - determines code spacing between lines */
      /* font-size: 14px; */
  }
</style>

**Analysis of contributors to Prosper loan scores**<br>by Charles Dellinger
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using in your analysis in this code
# chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk. This
# prevents the code from displaying in the knitted HTML output. You should set
# echo=FALSE for all code chunks in your file, unless it makes sense for your
# report to show the code that generated a particular plot.

# The other parameters for "message" and "warning" should also be set to FALSE
# for other code chunks once you have verified that each plot comes out as you
# want it to. This will clean up the flow of your report.

library(ggplot2)
library(gridExtra)
library(knitr)
library(dplyr)
library(GGally)
```


```{r echo=FALSE, message=FALSE, warning=FALSE, Load_the_Data}
# Load the Data
loanData <- read.csv('prosperLoanData.csv')
```

The data set is about personal loans made through [Prosper Marketplace](https://www.prosper.com).
Prosper anonymously connects private users who want to lend and borrow money.
The marketplace allows users to apply and receive loans from $2,000 to $40,000.
During the application process, fairly standard information, like income,
occupation, assets, and credit score, is collected. The application information
with additional data about the loan itself, including current state, is what
this data set contains. A full list of data collected about each loan is below:

<style>
  .col2 {
    columns: 2 200px;         /* number of columns and width in pixels*/
    -webkit-columns: 2 200px; /* chrome, safari */
    -moz-columns: 2 200px;    /* firefox */
  }
  .col3 {
    columns: 3 100px;
    -webkit-columns: 3 100px;
    -moz-columns: 3 100px;
  }
</style>

<div class="col2">
```{r echo=FALSE, Column_Names}
sort(names(loanData))
```
</div>

> # **Univariate Exploration**

## Univariate Plots Section

### IncomeRange

```{r echo=FALSE, message=FALSE, warning=FALSE, IncomeRange_to_IncomeRange2}
# histogram of IncomeRange
# ggplot(aes(x = IncomeRange), data = loanData) +
#   geom_histogram(stat="count") +
#   labs(x = "Income Range", y = "N") +
#   coord_flip()

# The plot of IncomeRange was unordered, so changing the variable to an ordered
# factor is necessary to get the plot to display logically.

# check the structure and get current headings
# str(loanData$IncomeRange)
# levels(loanData$IncomeRange)

# change the headings to an ordered factor
loanData$IncomeRange = factor(loanData$IncomeRange,
                              levels= c("Not displayed",
                                        "Not employed",
                                        "$0",
                                        "$1-24,999",
                                        "$25,000-49,999",
                                        "$50,000-74,999",
                                        "$75,000-99,999",
                                        "$100,000+"))

# check summary of IncomeRange
# kable(summary(loanData$IncomeRange), 
#       caption="Income Range Counts", 
#       align = c("r", "l"),
#       col.names = c("N"),
#       format = 'pandoc')

# create a new column that merges 'Not employed' and '$0',
# because unemployed people make $0 in theory
loanData$IncomeRange2 <- loanData$IncomeRange
loanData$IncomeRange2[loanData$IncomeRange2 == 'Not employed'] = '$0'

# check summary of IncomeRange2
# kable(summary(loanData$IncomeRange2),
#       caption="Revised Income Range Counts",
#       align = c("r", "l"),
#       col.names = c("N"),
#       format = 'pandoc')
```

```{r echo=FALSE, message=FALSE, warning=FALSE, IncomeRange2_Histogram}
# graph income ranges in IncomeRange2
ggplot(aes(x = IncomeRange2), data = loanData) +
  geom_histogram(stat="count") +
  labs(x = "Modified Income Range", y = "N") +
  coord_flip()

# get rid of 'Not displayed' on the graph
# ggplot(aes(x = IncomeRange2),
#        data = subset(loanData, IncomeRange2 != 'Not displayed')) +
#   geom_histogram(stat="count") + coord_flip()
```

The histogram of IncomeRange shows that most of the borrowers make between 
$25,000 to $75,000. However, there's a decent amount of 'Not displayed', which
is assumed to be borrower's who wanted to abstain from reporting or having it
reported. The 'Not displayed' seems to be a lot smaller than most of the range
counts, so it isn't likely to cause a misrepresentation if this variable is
used.

### StatedMonthlyIncome

```{r echo=FALSE,  message=FALSE, warning=FALSE, StatedIncome_Histogram}
ggplot(aes(x = StatedMonthlyIncome), data = loanData) +
  geom_histogram(binwidth = 12500) +
  scale_x_continuous(limits = c(0,175000)) +
  labs(x = 'Stated Monthly Income', y = 'N')
```

The stated monthly incomes look to be all bunched up in the low end. Zooming in
on the plot will give a better idea of the distribution.

```{r echo=FALSE,  message=FALSE, warning=FALSE, Log_StatedIncome_Histogram}
ggplot(aes(x = StatedMonthlyIncome), data = loanData) +
  geom_histogram(binwidth = 1000) +
  scale_x_continuous(limits = c(0,30000)) +
  #scale_y_log10() +
  labs(x = 'Stated Monthly Income', y = 'N')
```

The stated monthly income histogram paints a slightly different picture than the
income range bins. The income range bins had more of a bell-curve type shape,
whereas the stated income curve looks skewed right.

Will the StatedMonthlyIncome look the same if it is sorted into buckets?

```{r echo=FALSE,  message=FALSE, warning=FALSE, StatedMonthlyIncome_Bucket_Histogram}
# get endpoints for bucketing
# summary(loanData$StatedMonthlyIncome)

# cut to breakpoints of IncomeRange
loanData$StatedMonthlyIncome.bucket <-
  cut(as.numeric(loanData$StatedMonthlyIncome),
      breaks=c(0,1,
               25000,
               50000,
               75000,
               100000,
               Inf),
      labels=c("$0",
               "$1-24,999",
               "$25,000-49,999",
               "$50,000-74,999",
               "$75,000-99,999",
               "$100,000+"),
      right = FALSE)

# verify that bucketing worked
# table(loanData$StatedMonthlyIncome.bucket)

loanData$StatedMonthlyIncome.bucket <- 
  factor(loanData$StatedMonthlyIncome.bucket)
# loanData$StatedMonthlyIncome.bucket[loanData$StatedMonthlyIncome <= 100000] =
#   '100000+'
# loanData$StatedMonthlyIncome.bucket <-
#   factor(loanData$StatedMonthlyIncome.bucket,
#          )

ggplot(aes(x = StatedMonthlyIncome.bucket),
       data = subset(loanData,
                     !is.na(StatedMonthlyIncome.bucket))) +
  geom_histogram(stat="count") + coord_flip() +
  labs(y = 'N')
```

```{r echo=FALSE,  message=FALSE, warning=FALSE, check_income_buckets}
# look at IncomeRange2 counts for comparison
# table(loanData$IncomeRange2)

# look at StatedMonthlyIncome.bucket counts
# table(loanData$StatedMonthlyIncome.bucket)

# check range with a most of the entries and another range
# length(loanData$StatedMonthlyIncome[loanData$StatedMonthlyIncome >= 1 &
#                                     loanData$StatedMonthlyIncome < 25000])
# length(loanData$StatedMonthlyIncome[loanData$StatedMonthlyIncome >= 25000 &
#                                     loanData$StatedMonthlyIncome < 50000])

# everything adds up, so unsure about the difference in ranges
```

The histogram of StatedMonthlyIncome buckets doesn't seem to align with the
income buckets outlined by IncomeRange. Since most of the incomes are all in one
range, there's some problem with the StatedMonthlyIncome variable.

### Occupation

```{r echo=FALSE,  message=FALSE, warning=FALSE, fig.height=8, Occupation}
ggplot(aes(x = Occupation), data = loanData) +
  geom_histogram(stat="count") + coord_flip()
```

Occupation is going to be pretty useless for categorization as it is since there
are so many. Even if grouped, a category like healthcare workers would have 
different results for instance with a "Nurse's Aide" versus a "Doctor". Also,
the catch-all's of "Other" and "Professional" are ambiguous and seem to 
dominate; the proportion of Occupation entries:

```{r echo=FALSE,  message=FALSE, warning=FALSE, Occupation_counts}
professions <- c(sum(loanData$Occupation == 'Professional'),
                 sum(loanData$Occupation == 'Other'),
                 sum(loanData$Occupation != 'Other' &
                       loanData$Occupation != 'Professional' &
                       !is.na(loanData$Occupation)))
professions <- professions/sum(professions)
names(professions) <- c('Professional', 'Other', 'Everything Else')
print(professions)
```

With almost 40% of Occupation entries unusable, the subgroup analysis probably
won't produce generalizable results.

### Debt-to-Income Ratio

```{r echo=FALSE,  message=FALSE, warning=FALSE, DebtToIncomeRatio_Histogram}
# summary(loanData$DebtToIncomeRatio)

# this plot is okay, but the bin makes
ggplot(aes(x = DebtToIncomeRatio), data = loanData) +
  geom_histogram(breaks = seq(0,10,1)) +
  #scale_y_log10() +
  scale_x_continuous(breaks = seq(0,10,1))
```

Almost all the debt-to-income ratios are less than 1. People with more debt to
pay than their income would have an almost 100% chance of default.

```{r echo=FALSE,  message=FALSE, warning=FALSE, DebtToIncomeRatio_breakpoint_count}
dtiRatio <- c(with(loanData,
                   sum(DebtToIncomeRatio[!is.na(DebtToIncomeRatio)] <= 1)),
              with(loanData,
                   sum(DebtToIncomeRatio[!is.na(DebtToIncomeRatio)] > 1)))
names(dtiRatio) <- c('<= 1', '> 1')
print(dtiRatio)
```

Creating custom bins can help get a better feel with for the data with smaller
bins in the lower ratio sections to see finer details there.

```{r echo=FALSE, message=FALSE, warning=FALSE, More_DebtToIncome_Histograms, fig.width=12}
custom_scale <- c(seq(0,0.9,0.1),
                  seq(1,2.8,0.2),
                  seq(3,5.5,0.5),
                  seq(6,10,1))
ggplot(aes(x = DebtToIncomeRatio), data = loanData) +
  geom_histogram(breaks = custom_scale, size=10) +
  scale_x_continuous(breaks = custom_scale) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

# try log transform
# ggplot(aes(x = DebtToIncomeRatio), data = loanData) +
#   geom_histogram(breaks = seq(0,10,0.05)) +
#   scale_y_log10() +
#   scale_x_continuous(breaks = seq(0,10,1)) +
#   labs(x = 'Debt-to-Income Ratio',
#        y = 'Log(N)')
```

### Delinquencies in the Last 7 Years

```{r echo=FALSE,  message=FALSE, warning=FALSE, DelinquenciesLast7Years}
ggplot(aes(x = DelinquenciesLast7Years), data = loanData) +
  geom_histogram(breaks = seq(0,100,5)) +
  scale_x_continuous(breaks = seq(0,100,25))# + 
  # log scale misrepresents quantities as higher
  # scale_y_log10() 
```

The users applying for loans had a fair number of instances where the payments
were late. This metric is a mixed bag for lenders as it would mean that the
borrower would accrue interest but also the borrower has a higher risk of
default.

### Total Trades on the Prosper Platform

```{r echo=FALSE,  message=FALSE, warning=FALSE, TotalTrades }
ggplot(aes(x = TotalTrades), data = loanData) +
  geom_histogram()
```

In general, the number of trades is skewed to the right, but the curve between
0 and 50 shows that a lot of borrowers are repeat users.

### Term Length of Loans

```{r echo=FALSE, message=FALSE, warning=FALSE, Length_of_Terms}
ggplot(aes(x = Term), data = loanData) +
  geom_histogram(binwidth = 1)
```

The loans seem to be grouped in three discrete lengths.

```{r echo=FALSE, message=FALSE, warning=FALSE, Term_table}
# there looks to be three clear term lengths
# clear term demarkations can be confirmed by making a table
kable(table(loanData$Term),
      caption="Term Lengths",
      align = c("l", "r"),
      col.names = c("Term", "N"),
      format = 'pandoc')
```

The table confirms that the data set contains only three loan lengths, which
correspond to 1, 3, and 5 years. This variable would be a good variable to 
change to a categorical variable to split other plots in the future.

```{r echo=FALSE, message=FALSE, warning=FALSE, change_Terms_to_categories}
# examine the structure of loanData$Term
# str(loanData$Term)

# loanData$Term is currently an int
# change to factor for use in visualization
loanData$Term2 <- cut(loanData$Term,
                      breaks = c(0,12,36,60), 
                      labels = as.character(c("1 year",
                                              "3 years",
                                              "5 years")), 
                      right = TRUE)
loanData$Term2 <- factor(loanData$Term2,
                         levels = as.character(c("1 year",
                                                 "3 years",
                                                 "5 years")))
ggplot(aes(x = Term2), data = loanData) +
  geom_bar()
```

### Home Ownership

```{r echo=FALSE,  message=FALSE, warning=FALSE, Home_Ownership}
ggplot(aes(x = IsBorrowerHomeowner), data = loanData) +
  # geom_histogram(stat='count') + coord_flip()
  geom_bar()
```

Home ownership would show that a person has an asset, which would make the loan
more viable because the borrower can both make payments and has something to
borrow against if they need money to meet their liabilities.

This variable might be a good one to use to see split scores or behavior between
those that own a home or not.

### BankcardUtilization
This variable is strange: "The percentage of available revolving credit that is 
utilized at the time the credit profile was pulled." It seems like the amount of
available credit that the borrower is utilizing, or home much of the credit
card potential have they used.

```{r echo=FALSE,  message=FALSE, warning=FALSE, Bankcard_Utilization}
ggplot(aes(x = BankcardUtilization), data = loanData) +
  geom_histogram(binwidth = 0.05)

ggplot(aes(x = 1, y = BankcardUtilization), data = loanData) +
  geom_boxplot() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_flip() + scale_y_continuous(breaks = seq(0,6,0.25))

kable(round(as.array(summary(loanData$BankcardUtilization)), digits = 2),
      caption="Bankcard Utilization",
      align = c("l", "r"),
      col.names = c("Statistic", "Value"),
      format = 'pandoc')

```

The shape of the bank card utilization histogram shows a spike at 0% and then
an increasing trend as the percentage approaches 100%. The box plot show that
there are a fair number of people that have somehow over-drafted their bank cards
to a pretty high extent. The bank card percentage score would be an interesting
metric to test correlations to in the multivariate analysis.

### Credit Score Range

```{r echo=FALSE,  message=FALSE, warning=FALSE, Credit_Scores}
creditUpper <- ggplot(aes(x = CreditScoreRangeLower), data = loanData) +
  geom_histogram()
creditLower <- ggplot(aes(x = CreditScoreRangeUpper), data = loanData) +
  geom_histogram()
grid.arrange(creditUpper, creditLower, ncol = 1)
```

The shapes of the upper and lower credit scores histograms look roughly the 
same, so I would expect that the ranges are of a standard length of points. A
quick graph of the differences will confirm.

```{r echo=FALSE,  message=FALSE, warning=FALSE, "Differences of Upper and Lower Credit Scores"}
# differences of Upper and Lower Credit Scores

# looks like the range is only one length
ggplot(aes(x = (CreditScoreRangeUpper - CreditScoreRangeLower)),
       data = loanData) +
  geom_histogram()
# confirm the range is only one distance
with(loanData, table(CreditScoreRangeUpper - CreditScoreRangeLower))
```

Since the scores are of fixed length, any use of credit scores can use either
one to view any trends or make predictions.

### Prosper Score

```{r echo=FALSE,  message=FALSE, warning=FALSE, ProsperScore}
# p1 <- ggplot(aes(x = ProsperScore), data = loanData) +
#   geom_histogram() +
#   scale_x_continuous(limits = c(0,12), breaks = seq(1,11,1))
# # the cleaner plot hides that the scores are discrete
# p2 <- ggplot(aes(x = ProsperScore), data = loanData) +
#   geom_histogram(binwidth = 1, color = 'black', fill = 'blue') +
#   scale_x_continuous(limits = c(0,12), breaks = seq(1,11,1))
# grid.arrange(p1, p2, ncol = 1)

ggplot(aes(x = ProsperScore), data = loanData) +
  geom_histogram() +
  scale_x_continuous(limits = c(0,12), breaks = seq(1,11,1))

table(loanData$ProsperScore)
```

There seem to be only discrete Prosper scores and for some reason there are
score at 11, despite the range in the variable definition file indicating the
maximum is 10. Since Prosper score is made up of discrete levels, it can be
transformed into a categorical variable.

```{r echo=FALSE, message=FALSE, warning=FALSE, Create_ProsperScore2}
# create a discrete variable to change Prosper score to categorical
loanData$ProsperScore2 <- cut(loanData$ProsperScore,
                              breaks = c(seq(0,11,1)),
                              labels = as.character(seq(1,11,1)),
                              right = TRUE)
loanData$ProsperScore2 <- factor(loanData$ProsperScore2,
                                 levels = as.character(seq(1,11,1)))

ggplot(aes(x = ProsperScore2), 
       data = subset(loanData,
                     !is.na(ProsperScore2))) +
  geom_bar()
```

### Borrower APR

```{r echo=FALSE,  message=FALSE, warning=FALSE, BorrowerAPR}
ggplot(aes(x = BorrowerAPR), data = loanData) +
  geom_histogram()
```

The peak for borrower rates is on par with credit card rates with a roughly
even distribution above and below. This variable will probably be good to use
as a predictor.

### Loan Amount

```{r echo=FALSE,  message=FALSE, warning=FALSE, LoanOriginalAmount}
ggplot(aes(x = LoanOriginalAmount), data = loanData) +
  geom_histogram(binwidth = 1000) +
  scale_x_continuous(limits = c(2000,40000), breaks = seq(2000,40000,2000)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

According to the Prosper website, the loans are from $2000 to $40000. Most of
the loans are of low value, but there are some clear spikes at higher numbers
at 5k intervals ($10000, $15000, $20000, $25000), which shows a bias for people
rounding off for their needs.

## Univariate Analysis

### What is the structure of your dataset?
There are 113937 entries, each containing 84 variables of different types.

All of the data categories are related to whether the loan would be a good
investment or not, which is presumably wrapped into their proprietary Prosper
score.

### What is/are the main feature(s) of interest in your dataset?
The main features of concern are going to be the variables that are commonly
primary contributors to risk, such as assets, liabilities, and current state of
leverage. Presumably these will be rolled up and reflected in the Prosper score
("ProsperScore"). The following are a listing of those variables:
"IncomeRange", "DebtToIncomeRatio", "DelinquenciesLast7Years", "TotalTrades",
"Term", "IsBorrowerHomeowner", "BankcardUtilization", "BorrowerAPR",
"LoanOriginalAmount", "CreditScoreRangeLower"/"CreditScoreRangeUpper"

### What other features in the dataset do you think will help support your \
investigation into your feature(s) of interest?
Additional features that might build a richer picture would include:
"ListingCategory..numeric." - to see what the loan is for
"LoanStatus" - to check on overdue loans
"Investors" - how many people have confidence that the borrower will pay?
"Recommentations" - how many people vouch for the borrower?
"EmploymentStatusDuration" - is the borrower's cash flow consistent?
"Estimated Return" - to measure risk/benefit ratio
"Estimated Loss" - complement of the return

### Did you create any new variables from existing variables in the dataset?
I created IncomeRange2 and StatedMonthlyIncome.bucket:
* IncomeRange2 - consolidates "Not employed" to have an income of $0
* StatedMonthlyIncome.bucket - bucketed the StatedMonthlyIncome to test against
IncomeRange, but the results made it seem like the monthly income wasn't as
reliable.
* Term2 - changed Term into a categorical variable
* ProsperScore2 - changed ProsperScore into a categorical variable

### Of the features you investigated, were there any unusual distributions? \
Did you perform any operations on the data to tidy, adjust, or change the form \
of the data? If so, why did you do this?

All the data were skewed appropriately or of a normalized scoring. The
exceptions to a lot of distributions were around even number intervals, because
people round their expectation needs.

There were some strange things within some of the variables. The Prosper score
had scores of 11 even though the range was stated to be 1-10. There were
bankcard utilizations and debt-to-income ratios that were questionable, because
the borrower had much greater debt than they could pay, like the borrower that
had almost 600% bankcard utilization and the 799 borrowers that had more debt
payments per month than their monthly income.

> # **Bivariate & Multivariate Exploration**

In general, the bivariate plots didn't show anything unless augmented by another
variable, so the plot sections have been merged together. Most of the plots are
multivariate, but there are a few bivariate where the relationship is
straightforward enough.

## Bivariate & Multivariate Plots Section

A quick grid of relationships to see if anything sticks out:

```{r echo=FALSE,  message=FALSE, warning=FALSE, fig.height=16, fig.width=16, variables_grid}
# pairs of primary variables
ggpairs(data = loanData,
        columns = c("ProsperScore",
                    "IncomeRange",
                    "DebtToIncomeRatio",
                    "DelinquenciesLast7Years",
                    "TotalTrades",
                    "Term2",
                    "IsBorrowerHomeowner",
                    "BankcardUtilization",
                    "BorrowerAPR",
                    "LoanOriginalAmount",
                    "CreditScoreRangeLower"),
        axisLabels = "show")
```

Prosper score seems like a good place to start looking at affects of variables
on each other since it is a sort of summation of risk for the loan. The amount
of risk is usually passed on as a loan penalty in the form of APR. Therefore,
there should be relationship between Prosper and APR such that increased Prosper
score should have a lower APR and vice versa.

```{r echo=FALSE,  message=FALSE, warning=FALSE, Prosper_vs_APR}
ggplot(aes(x = BorrowerAPR,
           y = ProsperScore,
           color = Term2),
       data = loanData) +
  geom_jitter(alpha = 1/20)
```

As expected, there's a relationship with borrower APR and Prosper score. The
higher the Prosper score, the less risk, so the APR is lower. The coloring of
the visualization doesn't reveal that Term clearly augments this relationship
despite longer term loans having an intrinsically higher risk.

Since Prosper score is proprietary, it will be interesting to find out what else
goes into the Proper score. Outside of Prosper, APRs generally trend with the
non-proprietary credit score, so Prosper score and credit score would be
expected to be roughly trend together.

```{r echo=FALSE,  message=FALSE, warning=FALSE, PropserScore_vs_CreditScoreRangeLower}
ggplot(aes(x = CreditScoreRangeLower,
           y = ProsperScore),
       data = loanData) +
  geom_jitter(alpha = 1/30, aes(color = IncomeRange2)) +
  coord_flip()
```

Strangely, there doesn't seem to be much correlation if any between Prosper
score and Credit score despite both being compilation measures of risk for
financial institutions. Just how weak is the correlation?

```{r echo=FALSE,  message=FALSE, warning=FALSE, Propser_vs_Credit_Correlation}
with(loanData, cor.test(ProsperScore,CreditScoreRangeLower))
```

Despite the weak correlation of Prosper score and credit score, the coloring of
the visualization does reveal that people with higher income are more likely to
have a higher Prosper score, regardless of credit score.

```{r echo=FALSE,  message=FALSE, warning=FALSE, CreditScoreRangeLower_vs_APR}
ggplot(aes(x = BorrowerAPR,
           y = CreditScoreRangeLower,
           color = Term2),
       data = loanData) +
  geom_point(alpha = 1/20)

with(loanData, cor.test(ProsperScore,BorrowerAPR))
with(loanData, cor.test(CreditScoreRangeLower,BorrowerAPR))
```








Another measure of interest would be the relationship between the debt-to-income
ratio and Prosper score, since it is more risky to grant a loan to a borrower
as their amount of existing debt increases, or the borrower is more leveraged.

```{r echo=FALSE,  message=FALSE, warning=FALSE, Prosper_vs_DebtToIncomeRatio}
ggplot(aes(x = DebtToIncomeRatio,
           y = ProsperScore),
       data = loanData) +
  geom_jitter(alpha = 1/5, aes(color = IncomeRange2)) +
  xlim(c(0,1))
```

The relationship between debt-to-income ratio and Prosper score isn't as obvious
as expected, but the debt-to-income ratio range for the Prosper score extends
farther into a bad ratio for lower Prosper scores. However, the visualization
does show a relationship between the Prosper scare and income range. Borrowers
with a higher income are more likely to have a higher Prosper score across all
debt-to-income ratios.

Does total trades affect the Prosper score?

```{r echo=FALSE,  message=FALSE, warning=FALSE, Prosper_vs_TotalTrades}
ggplot(aes(x = TotalTrades,
           y = ProsperScore,
           color = loanData$TradesNeverDelinquent..percentage),
       data = loanData) +
  geom_jitter(alpha = 1/20) +
  labs(x = 'Total Trades',
       y = 'Prosper Score',
       color = '% Good Trades') +
  scale_x_continuous(limits = c(0,60))
```

The total number of trades on the platform doesn't affect the Prosper score. 
To eliminate the possibility of delinquent trades and good trades mixed together
causing hiding any trend, coloring based on percentage of good trades was added.
The coloring shows that all the colors are dispersed fairly evenly, so there
really isn't any trend.

```{r echo=FALSE,  message=FALSE, warning=FALSE, Create_GoodTrades}
# create a column for good trades
# loanData$GoodTrades <- loanData$TradesNeverDelinquent..percentage * loanData$TotalTrades
# 
# graph good trades
# ggplot(aes(x = GoodTrades,
#            y = ProsperScore),
#        data = loanData) +
#   geom_jitter(alpha = 1/20)

# the visualation of GoodTrades isn't any clearer and still shows no trend
```

The amount of delinquencies should affect the BorrowerAPR and Prosper score, 
since delinquencies could be a sign that the borrow has a hard time paying back
the loan.

```{r echo=FALSE, message=FALSE, warning=FALSE, APR_vs_Deliquencies}
# None of these show a trend
#
# aprVdeliq <- ggplot(aes(x = DelinquenciesLast7Years,
#                             y = BorrowerAPR),
#                         data = loanData)
# aprVdeliq1 <- aprVdeliq + geom_jitter(alpha = 1/40)
# aprVdeliq2 <- aprVdeliq + geom_jitter(alpha = 1/40, 
#                                               aes(color = IsBorrowerHomeowner))
# aprVdeliq3 <- aprVdeliq + geom_jitter(alpha = 1/40, 
#                                               aes(color = Term2))
# aprVdeliq4 <- aprVdeliq + geom_jitter(alpha = 1/40, 
#                                               aes(color = IncomeRange2))
# grid.arrange(aprVdeliq1, aprVdeliq2, aprVdeliq3, aprVdeliq4)

ggplot(aes(x = DelinquenciesLast7Years,
           y = BorrowerAPR),
       data = loanData) +
  geom_jitter(alpha = 1/40)
```

The expected trend between APR and delinquencies doesn't seem to show up even
when coloring based on previously identified categories. Will Prosper score 
show the same lack of trend? Or will the expected trend appear?

```{r echo=FALSE, message=FALSE, warning=FALSE, Prosper_vs_Deliquencies}
# None of these show a trend
#
# propserVdeliq <- ggplot(aes(x = DelinquenciesLast7Years,
#                             y = ProsperScore),
#                         data = loanData)
# propserVdeliq1 <- propserVdeliq + geom_jitter(alpha = 1/30)
# propserVdeliq2 <- propserVdeliq + geom_jitter(alpha = 1/30, 
#                                               aes(color = IsBorrowerHomeowner))
# propserVdeliq3 <- propserVdeliq + geom_jitter(alpha = 1/30, 
#                                               aes(color = Term2))
# propserVdeliq4 <- propserVdeliq + geom_jitter(alpha = 1/30, 
#                                               aes(color = IncomeRange2))
# grid.arrange(propserVdeliq1, propserVdeliq2, propserVdeliq3, propserVdeliq4)

ggplot(aes(x = DelinquenciesLast7Years,
           y = ProsperScore),
       data = loanData) +
  geom_jitter(alpha = 1/30)
```

Another logical affector on measures of risk (Prosper score and borrower APR)
would be how much available credit a borrower has to fulfill the obligation to
the Prosper loan. In theory, its a liquidity measure, so the more unused
immediately usable credit, the higher the Prosper score and lower the APR.

```{r echo=FALSE, message=FALSE, warning=FALSE, BankcardUtilization_vs_plots}
# ProsperScore
ggplot(aes(x = BankcardUtilization,
           y = ProsperScore,
           color = loanData$TradesNeverDelinquent..percentage),
       data = loanData) +
  geom_jitter(alpha = 1/30) +
  scale_x_continuous(limits = c(0,1)) +
  labs(color = '% Good Trades')
             
# BorrowerAPR
ggplot(aes(x = BankcardUtilization,
           y = BorrowerAPR,
           color = loanData$TradesNeverDelinquent..percentage),
       data = loanData) +
  geom_jitter(alpha = 1/40) +
  scale_x_continuous(limits = c(0,1)) +
  labs(color = '% Good Trades')

# correlations:
#
# with(loanData, cor.test(BankcardUtilization, ProsperScore))
# with(loanData, cor.test(BankcardUtilization, BorrowerAPR))
```

The expected trends hold up for Prosper score and APR vs bankcard utilization.

There haven't been too many trends in the Prosper score, so borrower APR will be
the focus moving forward.

```{r echo=FALSE,  message=FALSE, warning=FALSE, IncomeRange2_vs_BorrowerAPR_1}
ggplot(aes(x = BorrowerAPR,
           y = IncomeRange2,
           color = LoanOriginalAmount),
       data = subset(loanData,
                     IncomeRange2 != 'Not displayed')) +
  geom_jitter(alpha = 1/30)
```

Looking at the income range and borrower APR visualization, the APR's of higher
income borrowers are consolidated in a narrower areas in the lower APR range.
The high income borrowers look more likely to take out loans of higher amounts.
Lower income borrowers with low APR seem slightly more likely to take out larger
loan amounts.

```{r echo=FALSE,  message=FALSE, warning=FALSE, IncomeRange2_vs_BorrowerAPR_2}
ggplot(aes(x = BorrowerAPR,
           y = IncomeRange2,
           color = Term2),
       data = subset(loanData,
                     IncomeRange2 != 'Not displayed')) +
  geom_jitter(alpha = 1/10) +
  labs(x = 'Borrower APR',
       y = 'Income Range',
       color = 'Term')
```

Having an asset like a house would theoretically be good if a borrower is going
to take a loan.

```{r echo=FALSE,  message=FALSE, warning=FALSE, IncomeRange2_vs_BorrowerAPR_3}
ggplot(aes(x = BorrowerAPR,
           color = IsBorrowerHomeowner),
       data = subset(loanData,
                     IncomeRange2 != 'Not displayed')) +
  geom_freqpoly()
```

The expected relationship between APR and home ownership doesn't seem to hold
true. Is there a relationship between home ownership and income range?

```{r echo=FALSE,  message=FALSE, warning=FALSE, IncomeRange2_vs_Homeowner}
 ggplot(aes(x = IncomeRange2),
        data = subset(loanData,
                      IncomeRange2 != 'Not displayed')) +
   geom_histogram(stat='count') +
   facet_grid(IsBorrowerHomeowner~., labeller = label_both)

# this is a little clearer, despite being an awkward visualization
ggplot(aes(x = IsBorrowerHomeowner,
           y = IncomeRange2),
       data = subset(loanData,
                     IncomeRange2 != 'Not displayed')) +
  geom_jitter(alpha = 1/30)
```

People that make more money seem to be more likely to own a house, but the
effect isn't as strong as expected in the upper incomes.

```{r echo=FALSE,  message=FALSE, warning=FALSE, IncomeRange_vs_APR}
ggplot(aes(x = BorrowerAPR,
           y = IncomeRange2,
           color = IsBorrowerHomeowner),
       data = subset(loanData,
                     IncomeRange2 != 'Not displayed')) +
  geom_jitter(alpha = 1/30)
```

This visualization shows similar results to the previous ones. Borrower's with
higher incomes are more likely to have a better APR and be homeowners. The
visualization potentially misrepresents that there's a stronger relationship
with home ownership and APR.


Despite it popping up in other visualizations, the relationship between Prosper
score and income range hasn't been examined.

```{r echo=FALSE,  message=FALSE, warning=FALSE, Prosper_v_IncomeRange2}
ggplot(aes(x = IncomeRange2,
           y = ProsperScore),
       data = loanData) +
  geom_jitter(alpha = 1/30)
```

The relationship isn't as clear as expected, but the trend for higher Prosper
score for higher income range is there.

### Auxiliary Measures

Plots to look it will be sifted from a quick grid of relationships.

```{r echo=FALSE,  message=FALSE, warning=FALSE, fig.height=12, fig.width=12, ggpairs_auxiliary}
ggpairs(data = loanData,
        columns = c('BorrowerAPR',
                    'ProsperScore',
                    'IncomeRange2',
                    'LoanStatus',
                    'Investors',
                    'EmploymentStatusDuration',
                    'Recommendations',
                    'EstimatedReturn',
                    'EstimatedLoss'),
        axisLabels = 'show')
```

The Prosper score and estimated return look like they have some sort of
relationship, so that will be first.

```{r echo=FALSE,  message=FALSE, warning=FALSE, Prosper_vs_Return}
ggplot(data = loanData,
       aes(x = EstimatedReturn,
           y = ProsperScore)) +
  geom_jitter(alpha = 1/20) +
  scale_x_continuous(limits = c(0, 0.2))
```

The visualization is zoomed in where the most points are. There seems to be a
correlation, which makes sense. The higher the Prosper score, the less risk, so
the APR should be lower to reflect that, which means the return from interest
will be lower, in turn. The relationship can be verified by looking at the APR
visualizations.

```{r echo=FALSE,  message=FALSE, warning=FALSE, APR_v_EstimatedReturn}
ggplot(data = loanData,
       aes(x = EstimatedReturn,
           y = BorrowerAPR,
           color = Term2)) +
  geom_jitter()

ggplot(data = subset(loanData,
                     !is.na(ProsperScore2)),
       aes(x = EstimatedReturn,
           y = BorrowerAPR,
           color = ProsperScore2)) +
  geom_jitter(alpha = 1/10) +
  facet_grid(Term2~.)
```

The relationship between return an APR was interesting. There looked to be a
trend, but also it was clear there was something else augmenting it because
there was banding and some trends with different slope. After splitting the
visualization, most of the trends can be seen as owing to term length and
Prosper score (risk).

Another variable that seems to have some trends form the grid is employment
duration.

```{r echo=FALSE,  message=FALSE, warning=FALSE, employment_duration_plots}
ggplot(data = loanData,
       aes(x = EmploymentStatusDuration,
           y = IncomeRange2)) +
  geom_jitter(alpha = 1/50) +
  scale_x_continuous()

ggplot(data = loanData,
       aes(x = EmploymentStatusDuration,
           y = EstimatedReturn,
           color = BorrowerAPR)) +
  geom_point()
```

In the grid, there seemed to be a clearer positive correlation between
employment duration and income range, but on closer inspection, the employment
duration seems to peak in the middle income ranges and then reduce back to a
slightly higher baseline.

Additionally, there seemed to be a relationship with employment duration and
estimated return, but the trend seems to be blending of APR bands across all
employment durations.

## Bivariate & Multivariate Analysis

### Talk about some of the relationships you observed in this part of the \
investigation. How did the feature(s) of interest vary with other features in \
the data set?

The results of the investigation were mixed with some things trended as expected
and others did not. Examples of unexpected trends, the credit score had a very
weak correlation with the Prosper score, and a history of delinquencies, 
debt-to-income ratio, and home ownership didn't seem to affect the Prosper score.
Expected influencers based on theory showed up again with trends relating to 
Prosper score such as interest rate [APR] and income range.

### Did you observe any interesting relationships between the other features \
(not the main feature(s) of interest)?

Of the secondary features discussed in the univariate section, the one that
showed the best trends and, thus, visualizations was estimated return

### What was the strongest relationship you found?

Prosper score and income range kept popping up, but when visualized individually
it wasn't as strong as expected. The strongest relationship (based on
visualization) would probably be Prosper score to bankcard utilization. The
relationship owes itself to the bankcard credit line essentially acting as a
liquid asset to pay for the Prosper loan payment, making unused bankcard use
a strong indicator of reduced risk.

------

> # **Final Plots and Summary**

```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_theme_updates}
# center titles of all plots
theme_update(plot.title = element_text(hjust = 0.5))
```

### Plot One

```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_One}
ggplot(data = loanData,
       aes(x = BorrowerAPR,
           y = ProsperScore,
           color = IncomeRange2)) +
  geom_jitter(alpha = 1/10) +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(breaks = seq(0,10,2),
                     labels = seq(0,10,2)) +
  labs(title = 'Relationship of income range to Prosper score and APR',
       x = 'Borrower\'s Interest Rate [APR]',
       y = 'Prosper Score',
       color = 'Income Range') +
  scale_colour_brewer(type = 'seq',
                      palette = 'YlGnBu',
                      guide = guide_legend(override.aes = list(alpha = 1,
                                                               size = 2)))
```

### Description One
The visualization shows the relationship of the proprietary risk score to the
borrower's interest rate (APR) and income range. In theory, a better (higher) 
Prosper score means less risk and, therefore, a lower borrowing penalty in the
form of interest rate. Additionally, a higher cash flow, in the form of income
range, should reduce risk and result in a higher Prosper score and lower
interest rate. The plot corroborates with the theory behind the relationships. 

### Plot Two

```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_Two}
ggplot(data = subset(loanData,
                     !is.na(ProsperScore2)),
       aes(x = EstimatedReturn,
           y = BorrowerAPR,
           color = ProsperScore2)) +
  geom_jitter(alpha = 1/4) +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent) +
  facet_grid(Term2~.) +
  labs(title = paste('Relationship of estimated return to',
                     'interest rate and Prosper score'),
       y = 'Borrower\'s Interest Rate [APR]',
       x = 'Estimated Return',
       color = 'Prosper\nScore') +
  scale_colour_brewer(#type = 'div',
                      palette = 'BrBG',
                      guide = guide_legend(override.aes = list(alpha = 1,
                                                               size = 2)))
```

### Description Two
The visualization shows the relationship of Prosper score and interest rate to
estimated return. The 1 and 5 year loans look like they have sloped lines
with high interest rate and thus more return with worse Prosper score, which
aligns with the theory of increased interest burden with increased risk and the
interest burden creates the return. The 3 year loans have a piece in the middle
that matches up to the trend of the 1 and 5 year loans, but is also seems to
have banding where the return is shifting to less and less as the Prosper score
goes down reflecting the theoretical increase risk of default for people with a
worse proprietary credit score.

### Plot Three

```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_Three}
ggplot(aes(x = DebtToIncomeRatio,
           y = ProsperScore),
       data = loanData) +
  geom_jitter(alpha = 1/5, aes(color = IncomeRange2)) +
  xlim(c(0,1)) +
  labs(title = paste('Relationship of debt-to-income ratio to',
                     'Prosper score and income range'),
       x = 'Debt-to-Income Ratio',
       y = 'Prosper Score',
       color = 'Income Range') +
  scale_colour_brewer(guide = guide_legend(override.aes = list(alpha = 1,
                                                               size = 2)))
```

### Description Three

The visualization shows that the clustering of borrowers with a higher income
shifts up and to the left, so higher income borrowers are more likely to
have a lower debt-to-income ratio and better Prosper score. These trends align
with theory that, all things equal, more cash flow will result in less debt. 

------

> # **Reflection**

The exploration ended up with different results than I had imagined. There are
a lot of variables that theoretically influence risk that only had a weak
correlation with the Prosper score, which is the company's own credit score. For
instance, having more liquidity with lower bankcard utilization and higher cash 
flow with income range had a correlation which make sense because both would 
indicate an increased probability of paying the monthly payment. However, other
indicators of risk didn't have an effect.  Debt-to-income ratio (leverage),
which shows the proportion of liabilities to assets, should have some
correlation, since more debt repayment would indicate more risk that new  debt
might not get repaid, but the ratio didn't exhibit any noticeable correlation. 
A tangible asset like home ownership would also be something to borrow against or
could show that the borrower has the ability to pay big loans consistently, but 
home ownership didn't seem to have any affect on the Prosper score either.
Similarly, having a history of delinquent loans didn't seem to have a dramatic
affect, which should be a direct indicator of the risk of the loan getting paid
back. Additionally, the widely used credit score did not track well with Prosper
score, showing only a weak correlation.

With mixed results of theoretical predictors, exploration of additional
variables would be needed to sufficienty discover the components of how Prosper
determines and evaluates risk. Potential angles include examining loan statuses
and defining good and bad loans, because separating categories like late
payments (<30 days) versus people not being able to pay may paint a different
picture than just using "DelinquenciesLast7Years or
"TradesNeverDelinquent..percentage". Another thing to check into is trends over
time for risk measures using the closing date of the loan. Also, examination of
the historical Prosper score with 7 letter scale versus the 1-10 number scale
might be worth investigating to see if there's a difference in evaluation moving
forward from the switch, which might influence other things like interest rate.

> # **References**

<BR>
[RStudio cheatsheet](https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf)
<BR>
[RStudio cheatsheet 2.0](https://www.rstudio.com/wp-content/uploads/2016/03/rmarkdown-cheatsheet-2.0.pdf)
<BR>
[StackOverflow: Rotating and spacing axis labels in ggplot2](https://stackoverflow.com/questions/1330989/rotating-and-spacing-axis-labels-in-ggplot2?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa)
<BR>
[Debt to Income Ratio](https://www.consumerfinance.gov/ask-cfpb/what-is-a-debt-to-income-ratio-why-is-the-43-debt-to-income-ratio-important-en-1791/)
<BR>
[Remove all of x axis labels in ggplot (duplicate)](https://stackoverflow.com/questions/35090883/remove-all-of-x-axis-labels-in-ggplot?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa)
<BR>
[2 column Section in R Markdown](https://stackoverflow.com/questions/31753897/2-column-section-in-r-markdown?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa)
<BR>
[Tables with htmlTable and some alternatives](https://cran.r-project.org/web/packages/htmlTable/vignettes/tables.html)
<BR>
[Center Plot title in ggplot2](https://stackoverflow.com/questions/40675778/center-plot-title-in-ggplot2)
<BR>
[Useful labeller functions](https://ggplot2.tidyverse.org/reference/labellers.html)
<BR>
[Rmarkdown font size and header](https://stackoverflow.com/questions/30446905/rmarkdown-font-size-and-header/30447045)